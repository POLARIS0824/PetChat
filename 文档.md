# PetChat项目技术架构与运行逻辑文档

## 1. 项目概述

PetChat是一款基于Android平台的虚拟宠物聊天应用，允许用户与模拟的宠物角色进行交互对话。应用主要由聊天、名片夹、便利贴和萌友圈四大功能模块组成，核心功能是利用AI技术实现与虚拟宠物的自然对话。

## 2. 技术架构

### 2.1 架构模式

项目采用MVVM (Model-View-ViewModel) 架构模式，实现了UI和业务逻辑的分离：

- **View层**：使用Jetpack Compose构建的声明式UI界面
- **ViewModel层**：处理业务逻辑和状态管理（PetChatViewModel、NotesViewModel等）
- **Model层**：数据模型和Repository负责数据操作

### 2.2 技术栈

- **UI框架**：Jetpack Compose
- **UI设计**：Material 3
- **网络请求**：OkHttp
- **JSON解析**：Gson
- **本地存储**：Room数据库
- **异步处理**：Kotlin协程

### 2.3 核心组件

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│     View    │◄────►│  ViewModel  │◄────►│ Repository  │
│   (Compose) │      │             │      │             │
└─────────────┘      └─────────────┘      └─────────┬───┘
                                                   │
                                          ┌────────┴───────┐
                                          │                │
                                    ┌─────▼────┐    ┌──────▼─────┐
                                    │ Room DB  │    │ REST API   │
                                    │          │    │            │
                                    └──────────┘    └────────────┘
```

## 3. 数据模型

### 3.1 实体类

- **ChatMessage**：聊天消息模型
- **NoteEntity**：便利贴数据模型
- **PetTypes**：宠物类型枚举（CAT、DOG等）
- **PictureInfo**：图片信息模型

### 3.2 API模型

- **DeepseekRequest/Response**：与AI服务通信的请求和响应模型
- **ChatAnalysisResult**：聊天分析结果模型

## 4. 核心功能实现

### 4.1 聊天功能

#### 4.1.1 聊天流程

1. 用户在UI输入消息，发送给ViewModel
2. ViewModel将用户消息保存到数据库，并通过Repository请求AI响应
3. Repository构建包含历史消息和系统提示的请求发送给API
4. 接收AI响应后更新UI显示

```
用户输入 → ViewModel → Repository → AI API → 响应处理 → UI更新
```

#### 4.1.2 智能特性

- **上下文记忆**：保存历史消息，让AI能够参考之前的对话
- **宠物个性化**：不同宠物类型有不同的系统提示词，形成独特人格
- **用户画像分析**：分析用户聊天习惯，自动调整AI响应风格

### 4.2 便利贴功能

- 支持创建、过滤、查看与宠物相关的便利贴
- 按宠物类型进行过滤显示
- 使用LazyVerticalGrid网格布局展示便利贴

### 4.3 名片夹功能

- 展示宠物信息卡片
- 使用卡片形式展示宠物基本资料

### 4.4 萌友圈功能

- 社交分享模块（根据代码中的引用推断存在）

## 5. 数据存储与管理

### 5.1 本地数据库

使用Room数据库存储：
- 聊天记录
- 便利贴
- 聊天分析结果

### 5.2 数据优化策略

- **消息历史优化**：限制上下文长度，只保留最近的几条消息
- **自动分析**：当未处理消息达到10条时，触发自动分析
- **会话摘要**：当历史消息过多时，自动生成摘要减少存储量

## 6. AI交互实现

### 6.1 API调用

- 使用Deepseek API提供AI能力
- 请求包含系统提示、历史消息和用户输入
- 响应包含AI生成的文本和可能的图片信息

### 6.2 提示词工程

- 针对不同宠物类型设计不同的角色提示词
- 基于用户分析结果增强提示词，实现个性化
- 使用压缩版提示词优化请求大小

## 7. UI组件与交互

### 7.1 主要界面

- **聊天界面**：展示消息气泡，支持输入和发送
- **便利贴界面**：网格显示便利贴，支持过滤
- **名片夹界面**：展示宠物信息卡片
- **萌友圈界面**：社交内容展示

### 7.2 导航与状态管理

- 使用底部导航栏在四大功能间切换
- 使用侧边抽屉菜单提供附加功能
- 应用状态由ViewModel管理并通过Compose的State向UI提供

## 8. 性能优化

- **异步处理**：所有网络和数据库操作使用协程
- **加载状态管理**：区分前台和后台加载状态
- **消息缓存**：减少不必要的API调用

## 9. 系统流程

### 9.1 应用启动流程

1. MainActivity启动，初始化UI组件
2. 加载主题和必要权限
3. 初始化ViewModel
4. 从数据库加载历史聊天记录

### 9.2 消息处理流程

1. 用户发送消息
2. 前台显示加载状态
3. 保存用户消息到数据库
4. 获取AI响应
5. 更新UI并保存响应
6. 判断是否需要进行后台分析

### 9.3 数据分析流程

1. 累积足够的未处理消息
2. 触发分析请求
3. 将分析结果保存到数据库
4. 标记消息为已处理

## 10. 项目结构

```
com.example.chat/
├── MainActivity.kt                  # 应用主入口
├── PetChatViewModel.kt              # 聊天主ViewModel
├── PetChatRepository.kt             # 数据仓库
├── model/                           # 数据模型
│   ├── ApiModels.kt                 # API相关模型
│   ├── PetTypes.kt                  # 宠物类型枚举
│   └── ...
├── ui/                              # UI组件
│   ├── NotesScreen.kt               # 便利贴界面
│   ├── social/
│   │   └── SocialScreen.kt          # 萌友圈界面
│   └── ...
└── data/                            # 数据操作相关
    ├── ChatDao.kt                   # 数据访问对象
    ├── ChatDatabase.kt              # Room数据库
    └── ...
```

通过这一系统架构设计，PetChat应用实现了高效、个性化的虚拟宠物聊天体验，并通过数据分析和智能优化提供了更加自然的交互。
